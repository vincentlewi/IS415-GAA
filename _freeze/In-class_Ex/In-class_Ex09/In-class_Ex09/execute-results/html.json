{
  "hash": "8529e3a90f4e51a89bf09c54dc2a834d",
  "result": {
    "markdown": "---\ntitle: \"In-class Exercise 9: Geographically Weighted Predictive Models\"\nformat: \n  html:\n    code-summary: \"Show code\"\n    toc-depth: 3\n    code-overflow: \"scroll\"\nauthor: \"Alexander Vincent Lewi\"\ndate: \"18 March 2024\"\nexecute: \n  freeze: true\n  message: false\n  warning: false\n---\n\n\n## Packages\n\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(sf, spdep, GWmodel, SpatialML, \n               tmap, tidymodels, tidyverse,\n               gtsummary, rpart, rpart.plot,\n               ggstatsplot, performance)\n```\n:::\n\n\n## Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrs_sf <- read_rds('data/rds/HDB_resale.rds')\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrs_sf\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSimple feature collection with 15901 features and 17 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: 11597.31 ymin: 28217.39 xmax: 42623.63 ymax: 48741.06\nProjected CRS: SVY21 / Singapore TM\n# A tibble: 15,901 × 18\n   RESALE_PRICE FLOOR_AREA_SQM STOREY_ORDER REMAINING_LEASE_MTHS PROX_CBD\n          <dbl>          <dbl>        <int>                <dbl>    <dbl>\n 1       330000             92            1                  684     8.82\n 2       360000             91            3                  738     9.84\n 3       370000             92            1                  733     9.56\n 4       375000             99            2                  700     9.61\n 5       380000             92            2                  715     8.35\n 6       380000             92            4                  732     9.49\n 7       385000             92            3                  706     8.96\n 8       395000             92            2                  745     9.81\n 9       395000             93            4                  731    10.3 \n10       395000             91            3                  725    10.4 \n# ℹ 15,891 more rows\n# ℹ 13 more variables: PROX_ELDERLYCARE <dbl>, PROX_HAWKER <dbl>,\n#   PROX_MRT <dbl>, PROX_PARK <dbl>, PROX_GOOD_PRISCH <dbl>, PROX_MALL <dbl>,\n#   PROX_CHAS <dbl>, PROX_SUPERMARKET <dbl>, WITHIN_350M_KINDERGARTEN <int>,\n#   WITHIN_350M_CHILDCARE <int>, WITHIN_350M_BUS <int>,\n#   WITHIN_1KM_PRISCH <int>, geometry <POINT [m]>\n```\n:::\n:::\n\n\nLet's split the data into training and testing sets with a 50-50 split.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1234)\nresale_split <- initial_split(\n  rs_sf,\n  prop = 5/10)\ntrain_sf <- training(resale_split)\ntest_sf <- testing(resale_split)\n```\n:::\n\n\nWe first need to convert the data to a dataframe of base R because the `SpatialML` package only work with dataframes.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntrain_df <- train_sf |>\n  st_drop_geometry() |>\n  as.data.frame()\n\ntest_df <- test_sf |>\n  st_drop_geometry() |>\n  as.data.frame()\n```\n:::\n\n::: {.cell fig_width='12' fig_height='12'}\n\n```{.r .cell-code}\nrs_sf1 <- rs_sf |>\n  st_drop_geometry()\nggcorrmat(rs_sf1[, 2:17])\n```\n\n::: {.cell-output-display}\n![](In-class_Ex09_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrs_mlr <- lm(RESALE_PRICE ~ ., data = train_df)\ntbl_regression(rs_mlr)\n```\n\n::: {.cell-output-display}\n```{=html}\n<div id=\"picinvvobf\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#picinvvobf table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#picinvvobf thead, #picinvvobf tbody, #picinvvobf tfoot, #picinvvobf tr, #picinvvobf td, #picinvvobf th {\n  border-style: none;\n}\n\n#picinvvobf p {\n  margin: 0;\n  padding: 0;\n}\n\n#picinvvobf .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#picinvvobf .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#picinvvobf .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#picinvvobf .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#picinvvobf .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#picinvvobf .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#picinvvobf .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#picinvvobf .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#picinvvobf .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#picinvvobf .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#picinvvobf .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#picinvvobf .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#picinvvobf .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#picinvvobf .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#picinvvobf .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#picinvvobf .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#picinvvobf .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#picinvvobf .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#picinvvobf .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#picinvvobf .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#picinvvobf .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#picinvvobf .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#picinvvobf .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#picinvvobf .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#picinvvobf .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#picinvvobf .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#picinvvobf .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#picinvvobf .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#picinvvobf .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#picinvvobf .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#picinvvobf .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#picinvvobf .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#picinvvobf .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#picinvvobf .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#picinvvobf .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#picinvvobf .gt_left {\n  text-align: left;\n}\n\n#picinvvobf .gt_center {\n  text-align: center;\n}\n\n#picinvvobf .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#picinvvobf .gt_font_normal {\n  font-weight: normal;\n}\n\n#picinvvobf .gt_font_bold {\n  font-weight: bold;\n}\n\n#picinvvobf .gt_font_italic {\n  font-style: italic;\n}\n\n#picinvvobf .gt_super {\n  font-size: 65%;\n}\n\n#picinvvobf .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#picinvvobf .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#picinvvobf .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#picinvvobf .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#picinvvobf .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#picinvvobf .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#picinvvobf .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;Characteristic&lt;/strong&gt;\"><strong>Characteristic</strong></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;Beta&lt;/strong&gt;\"><strong>Beta</strong></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;95% CI&lt;/strong&gt;&lt;span class=&quot;gt_footnote_marks&quot; style=&quot;white-space:nowrap;font-style:italic;font-weight:normal;&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/span&gt;\"><strong>95% CI</strong><span class=\"gt_footnote_marks\" style=\"white-space:nowrap;font-style:italic;font-weight:normal;\"><sup>1</sup></span></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"&lt;strong&gt;p-value&lt;/strong&gt;\"><strong>p-value</strong></th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">FLOOR_AREA_SQM</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">2,803</td>\n<td headers=\"ci\" class=\"gt_row gt_center\">2,601, 3,005</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\"><0.001</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">STOREY_ORDER</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">14,044</td>\n<td headers=\"ci\" class=\"gt_row gt_center\">13,292, 14,796</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\"><0.001</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">REMAINING_LEASE_MTHS</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">345</td>\n<td headers=\"ci\" class=\"gt_row gt_center\">335, 355</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\"><0.001</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">PROX_CBD</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">-17,918</td>\n<td headers=\"ci\" class=\"gt_row gt_center\">-18,434, -17,403</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\"><0.001</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">PROX_ELDERLYCARE</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">-14,469</td>\n<td headers=\"ci\" class=\"gt_row gt_center\">-16,672, -12,265</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\"><0.001</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">PROX_HAWKER</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">-17,101</td>\n<td headers=\"ci\" class=\"gt_row gt_center\">-19,961, -14,240</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\"><0.001</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">PROX_MRT</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">-31,603</td>\n<td headers=\"ci\" class=\"gt_row gt_center\">-35,448, -27,758</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\"><0.001</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">PROX_PARK</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">-9,334</td>\n<td headers=\"ci\" class=\"gt_row gt_center\">-12,677, -5,992</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\"><0.001</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">PROX_GOOD_PRISCH</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">2,787</td>\n<td headers=\"ci\" class=\"gt_row gt_center\">2,036, 3,539</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\"><0.001</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">PROX_MALL</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">-12,320</td>\n<td headers=\"ci\" class=\"gt_row gt_center\">-16,777, -7,863</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\"><0.001</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">PROX_CHAS</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">-9,057</td>\n<td headers=\"ci\" class=\"gt_row gt_center\">-23,168, 5,054</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\">0.2</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">PROX_SUPERMARKET</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">-25,758</td>\n<td headers=\"ci\" class=\"gt_row gt_center\">-35,671, -15,845</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\"><0.001</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">WITHIN_350M_KINDERGARTEN</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">8,707</td>\n<td headers=\"ci\" class=\"gt_row gt_center\">7,297, 10,117</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\"><0.001</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">WITHIN_350M_CHILDCARE</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">-4,537</td>\n<td headers=\"ci\" class=\"gt_row gt_center\">-5,317, -3,756</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\"><0.001</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">WITHIN_350M_BUS</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">1,067</td>\n<td headers=\"ci\" class=\"gt_row gt_center\">573, 1,562</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\"><0.001</td></tr>\n    <tr><td headers=\"label\" class=\"gt_row gt_left\">WITHIN_1KM_PRISCH</td>\n<td headers=\"estimate\" class=\"gt_row gt_center\">-8,192</td>\n<td headers=\"ci\" class=\"gt_row gt_center\">-9,277, -7,108</td>\n<td headers=\"p.value\" class=\"gt_row gt_center\"><0.001</td></tr>\n  </tbody>\n  \n  <tfoot class=\"gt_footnotes\">\n    <tr>\n      <td class=\"gt_footnote\" colspan=\"4\"><span class=\"gt_footnote_marks\" style=\"white-space:nowrap;font-style:italic;font-weight:normal;\"><sup>1</sup></span> CI = Confidence Interval</td>\n    </tr>\n  </tfoot>\n</table>\n</div>\n```\n:::\n:::\n\n\nWe can see that all the variables are significant, except `PROX_CHAS`. So, we will remove it.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntrain_df <- train_df |>\n  select(-PROX_CHAS)\ntest_df <- test_df |>\n  select(-PROX_CHAS)\ntrain_sf <- train_sf |>\n  select(-PROX_CHAS)\ntest_sf <- test_sf |>\n  select(-PROX_CHAS)\n```\n:::\n\n\nNow let's fit the model with the processed data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrs_mlr <- lm(RESALE_PRICE ~ ., data = train_df)\n```\n:::\n\n\n> Or, similarly, we can just remove the `PROX_CHAS` variable from the formula if you do not want to remove it from your dataframe using the code below.\n>\n> `rs_mlr <- lm(RESALE_PRICE ~ . -PROX_CHAS, data = train_df)`\n\n## Calibrating the GWRF model\n\nThe code chunk below extracts the x and y coordinates of the full, training, and the test data. We need to do this because the `SpatialML` package needs a separate dataframe for the x and y coordinates, unlike the GWR model that we used in the previous lesson.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoords <- st_coordinates(rs_sf)\ncorrds_train <- st_coordinates(train_sf)\ncorrds_test <- st_coordinates(test_sf)\n```\n:::\n\n\n### Rpart\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrs_rp <- rpart(RESALE_PRICE ~ ., data = train_df)\nrpart.plot(rs_rp)\n```\n\n::: {.cell-output-display}\n![](In-class_Ex09_files/figure-html/unnamed-chunk-11-1.png){width=1344}\n:::\n:::\n\n\n### RF\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1234)\nrs_rf <- ranger(formula = RESALE_PRICE ~ ., data = train_df, importance = \"impurity\")\nrs_rf\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nwrite_rds(rs_rf, \"data/models/rs_rf.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrs_rf <- read_rds(\"data/models/rs_rf.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nvi <- as.data.frame(rs_rf$variable.importance)\nvi$variables <- rownames(vi)\nvi <- vi |> rename(vi = \"rs_rf$variable.importance\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = vi,\n       aes(x = vi,\n           y = reorder(variables, vi))) +\n  geom_bar(stat=\"identity\")\n```\n\n::: {.cell-output-display}\n![](In-class_Ex09_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\n> For cleaner code, we can just use `geom_col()` instead of `geom_bar(stat=\"identity\")`.\n>\n> `ggplot(data = vi) + geom_col(aes(x = vi, y = reorder(variables, vi)))`\n\nFrom the output above, we can see that the model work well with the variables provided. However, if the model cannot utilize the variables, your model might suffer from quasi-separation or quasi complete separation problem.\n\nNow, we can use the model to predict the test data.\n\n::: {.cell}\n\n```{.r .cell-code}\ngrf_pred <- predict(rs_rf, data = test_df)\nwrite_rds(grf_pred, \"data/models/grf_pred.rds\")\n\nrf_pred <- predict(rs_rf, data = test_df)\nwrite_rds(rf_pred, \"data/models/rf_pred.rds\")\n\nmlr_pred <- predict(rs_mlr, test_df)\nwrite_rds(mlr_pred, \"data/models/mlr_pred.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ngrf_pred <- read_rds(\"data/models/grf_pred.rds\")\ngrf_pred_df <- as.data.frame(grf_pred$predictions) |> rename(grf_pred = \"grf_pred$predictions\")\n\nrf_pred <- read_rds(\"data/models/rf_pred.rds\")\nrf_pred_df <- as.data.frame(rf_pred$predictions) |> rename(rf_pred = \"rf_pred$predictions\")\n\nmlr_pred <- read_rds(\"data/models/mlr_pred.rds\")\nmlr_pred_df <- as.data.frame(mlr_pred) |> rename(mlr_pred = \"mlr_pred\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntest_pred <- test_df |>\n  select(RESALE_PRICE) |>\n  cbind(grf_pred_df, rf_pred_df, mlr_pred_df)\n```\n:::\n\n\nto comparison between the models\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmc <- test_pred |> pivot_longer(cols=c(2:4),\n                                names_to = \"models\",\n                                values_to = \"predicted\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmc |> group_by(models) |> yardstick::rmse(RESALE_PRICE, predicted)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 3 × 4\n  models   .metric .estimator .estimate\n  <chr>    <chr>   <chr>          <dbl>\n1 grf_pred rmse    standard      28348.\n2 mlr_pred rmse    standard      61617.\n3 rf_pred  rmse    standard      28348.\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmc |> group_by(models) |> yardstick::mape(RESALE_PRICE, predicted)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 3 × 4\n  models   .metric .estimator .estimate\n  <chr>    <chr>   <chr>          <dbl>\n1 grf_pred mape    standard        4.57\n2 mlr_pred mape    standard       10.8 \n3 rf_pred  mape    standard        4.57\n```\n:::\n:::\n\n\n\nWe can see that the random forest model outperforms the multi regression model. The basic non-geographic random forest model is better than the geographic random forest model. Therefore, in this use case, we will just use the random forest model because it runs faster than the geographic random forest model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = test_pred,\n       aes(x = grf_pred,\n           y=RESALE_PRICE)) +\n  geom_point()\n```\n\n::: {.cell-output-display}\n![](In-class_Ex09_files/figure-html/unnamed-chunk-23-1.png){width=672}\n:::\n:::",
    "supporting": [
      "In-class_Ex09_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}